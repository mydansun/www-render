global
  log stdout format raw local0

defaults
  mode http
  log global
  option httplog
  option log-health-checks
  timeout connect 10s
  timeout client  120s
  timeout server  120s

resolvers pubdns
  nameserver dns1 1.1.1.1:53
  nameserver dns2 8.8.8.8:53
  resolve_retries       3
  timeout resolve       1s
  timeout retry         1s
  hold valid            60s

frontend stats
  bind :8404
  stats enable
  stats uri /
  stats refresh 10s

frontend fe_from_nginx
  bind :8080
  use_backend hetzner if { nbsrv(london) eq 0 }
  default_backend london

backend london
  http-response set-header X-Backend "%b/%s"
  option httpchk
  http-check connect ssl port 443 sni x-render.mskdoctors.co.uk
  http-check send meth GET uri /health ver HTTP/1.1 hdr Host x-render.mskdoctors.co.uk hdr Connection close
  default-server resolvers pubdns resolve-prefer ipv4 ssl alpn http/1.1 verify required ca-file @system-ca check inter 60s fall 3 rise 2
  http-request set-header Host x-render.mskdoctors.co.uk
  server worksation x-render.mskdoctors.co.uk:443 sni str(x-render.mskdoctors.co.uk) verifyhost x-render.mskdoctors.co.uk

backend hetzner
  http-response set-header X-Backend "%b/%s"
  option httpchk
  http-check connect ssl port 443 sni d-render.mskdoctors.co.uk
  http-check send meth GET uri /health ver HTTP/1.1 hdr Host d-render.mskdoctors.co.uk hdr Connection close
  default-server resolvers pubdns resolve-prefer ipv4 ssl alpn http/1.1 verify required ca-file @system-ca check inter 60s fall 3 rise 2
  http-request set-header Host d-render.mskdoctors.co.uk
  server de d-render.mskdoctors.co.uk:443 sni str(d-render.mskdoctors.co.uk) verifyhost d-render.mskdoctors.co.uk
